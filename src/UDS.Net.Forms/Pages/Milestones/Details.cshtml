@page
@using UDS.Net.API.Entities
@using UDS.Net.Services.DomainModels.Submission
@using UDS.Net.Services.Enums 
@model UDS.Net.Forms.Pages.Milestones.DetailsModel

@{
    ViewData["Title"] = Model.PageTitle;
}

<nav class="hidden sm:flex" aria-label="Breadcrumb">
    <ol role="list" class="flex items-center space-x-4">
        <li>
            <div class="flex">
                <a asp-page="/Participations/Details" asp-route-id="@Model.Milestone.ParticipationId" class="text-sm font-medium text-gray-500 hover:text-gray-700">Participation @(Model.Milestone.Participation != null ? Model.Milestone.Participation.LegacyId : "")</a>
            </div>
        </li>
    </ol>
</nav>

<div class="space-y-16 p-16 xl:space-y-20">
    <input type="hidden" asp-for="Milestone.Id" />
    <input type="hidden" asp-for="Milestone.ParticipationId" />
    <table class="table-auto border-separate border-spacing-y-5">
        <tbody>
            <tr>
                <td>
                    <label asp-for="Milestone.Status">@Html.DisplayNameFor(model => model.Milestone.Status)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.Status" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.CHANGEMO">@Html.DisplayNameFor(model => model.Milestone.CHANGEMO)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.CHANGEMO" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.CHANGEDY">@Html.DisplayNameFor(model => model.Milestone.CHANGEDY)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.CHANGEDY" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.CHANGEYR">@Html.DisplayNameFor(model => model.Milestone.CHANGEYR)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.CHANGEYR" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.PROTOCOL">@Html.DisplayNameFor(model => model.Milestone.PROTOCOL)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.PROTOCOL" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.ACONSENT">@Html.DisplayNameFor(model => model.Milestone.ACONSENT)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.ACONSENT" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.RECOGIM">@Html.DisplayNameFor(model => model.Milestone.RECOGIM)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.RECOGIM" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.REPHYILL">@Html.DisplayNameFor(model => model.Milestone.REPHYILL)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.REPHYILL" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.REREFUSE">@Html.DisplayNameFor(model => model.Milestone.REREFUSE)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.REREFUSE" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.RENAVAIL">@Html.DisplayNameFor(model => model.Milestone.RENAVAIL)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.RENAVAIL" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.RENURSE">@Html.DisplayNameFor(model => model.Milestone.RENURSE)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.RENURSE" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.NURSEMO">@Html.DisplayNameFor(model => model.Milestone.NURSEMO)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.NURSEMO" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.NURSEDY">@Html.DisplayNameFor(model => model.Milestone.NURSEDY)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.NURSEDY" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.NURSEYR">@Html.DisplayNameFor(model => model.Milestone.NURSEYR)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.NURSEYR" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.REJOIN">@Html.DisplayNameFor(model => model.Milestone.REJOIN)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.REJOIN" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.FTLDDISC">@Html.DisplayNameFor(model => model.Milestone.FTLDDISC)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.FTLDDISC" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.FTLDREAS">@Html.DisplayNameFor(model => model.Milestone.FTLDREAS)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.FTLDREAS" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.FTLDREAX">@Html.DisplayNameFor(model => model.Milestone.FTLDREAX)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.FTLDREAX" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DECEASED">@Html.DisplayNameFor(model => model.Milestone.DECEASED)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DECEASED" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DISCONT">@Html.DisplayNameFor(model => model.Milestone.DISCONT)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DISCONT" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DEATHMO">@Html.DisplayNameFor(model => model.Milestone.DEATHMO)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DEATHMO" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DEATHDY">@Html.DisplayNameFor(model => model.Milestone.DEATHDY)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DEATHDY" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DEATHYR">@Html.DisplayNameFor(model => model.Milestone.DEATHYR)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DEATHYR" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.AUTOPSY">@Html.DisplayNameFor(model => model.Milestone.AUTOPSY)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.AUTOPSY" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DISCMO">@Html.DisplayNameFor(model => model.Milestone.DISCMO)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DISCMO" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DISCDAY">@Html.DisplayNameFor(model => model.Milestone.DISCDAY)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DISCDAY" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DISCYR">@Html.DisplayNameFor(model => model.Milestone.DISCYR)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DISCYR" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DROPREAS">@Html.DisplayNameFor(model => model.Milestone.DROPREAS)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DROPREAS" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.CreatedAt">@Html.DisplayNameFor(model => model.Milestone.CreatedAt)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.CreatedAt" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.CreatedBy">@Html.DisplayNameFor(model => model.Milestone.CreatedBy)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.CreatedBy" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.ModifiedBy">@Html.DisplayNameFor(model => model.Milestone.ModifiedBy)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.ModifiedBy" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.DeletedBy">@Html.DisplayNameFor(model => model.Milestone.DeletedBy)</label>
                </td>
                <td>
                    <input readonly asp-for="Milestone.DeletedBy" />
                </td>
            </tr>
            <tr>
                <td>
                    <label asp-for="Milestone.IsDeleted">@Html.DisplayNameFor(model => model.Milestone.IsDeleted)</label>
                </td>
                <td>
                    <input type="text" readonly asp-for="Milestone.IsDeleted" />
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div>
    <a class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" asp-page="/MilestonesSubmissionErrors/Index">
        Import Error File
    </a>
</div>

<div class="mt-8">
    <h2 class="text-xl font-bold mb-4">M1 Submissions</h2>

    <table class="w-full text-left border border-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2">Id</th>
                <th class="px-4 py-2">Submission date</th>
                <th class="px-4 py-2">Created at</th>
                <th class="px-4 py-2">Created by</th>
                <th class="px-4 py-2">Modified by</th>
                <th class="px-4 py-2">Error count</th>
                <th class="px-4 py-2">Download</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var submission in Model.Milestone.M1Submissions)
            {
                <tr class="border-t border-gray-100" id="m1_submission_@submission.Id">
                    <td class="px-4 py-2">@submission.Id</td>
                    <td class="px-4 py-2">@submission.SubmissionDate</td>
                    <td class="px-4 py-2">@submission.CreatedAt</td>
                    <td class="px-4 py-2">@submission.CreatedBy</td>
                    <td class="px-4 py-2">@submission.ModifiedBy</td>
                    <td class="px-4 py-2">@submission.ErrorCount</td>
                    <td class="px-4 py-2">
                        <a asp-route-id="@submission.Id">Download</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@{
    var totalErrors = Model.Milestone.M1Submissions
        .Where(s => s.Errors != null && s.Errors.Any())
        .Sum(s => s.Errors.Count);
}


@if (Model.Milestone.M1Submissions.Any(s => s.Errors != null && s.Errors.Any()))
{
    <div class="mt-12">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-bold text-red-700 flex items-center gap-2">
                    Errors / Alert
                </h2>
            </div>
        </div>

        <div class="overflow-x-auto rounded-2xl border border-red-200 bg-white shadow-lg">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-red-50">
                    <tr>
                        <th class="px-4 py-2 text-left font-semibold text-gray-900">Submission Id</th>
                        <th class="px-4 py-2 text-left font-semibold text-gray-900">Message</th>
                        <th class="px-4 py-2 text-left font-semibold text-gray-900">Location</th>
                        <th class="px-4 py-2 text-left font-semibold text-gray-900">Value</th>
                        <th class="px-4 py-2 text-left font-semibold text-gray-900">Level</th>
                        <th class="px-4 py-2 text-left font-semibold text-gray-900">Status</th>
                        <th class="px-4 py-2 text-left font-semibold text-gray-900">Date Recorded</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100">
                    @foreach (var submission in Model.Milestone.M1Submissions.Where(s => s.Errors != null && s.Errors.Any()))
                    {
                        @foreach (var error in submission.Errors)
                        {
                            <tr class="bg-white">
                                <td class="px-4 py-2">@submission.Id</td>
                                <td class="px-4 py-2">@error.Message</td>
                                <td class="px-4 py-2">@error.Location</td>
                                <td class="px-4 py-2">@error.Value</td>
                                <td class="px-4 py-2">@error.Level</td>
                                <td class="px-4 py-2">@error.Status</td>
                                <td class="px-4 py-2">@error.CreatedAt</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
}
